# [こちら](https://eng-blog.iij.ad.jp/archives/18584)の記事メモ
## 用語解説
- ブラウザ(browser)/ウェブブラウザ(Web browser)
    - 利用者がChrome、Firefox、Safari、EdgeなどWebサイトを閲覧するプログラムの総称です。
- Webサーバ(Web server)
    - Webのコンテンツ(ページ)を提供するサーバです。
- プロキシ(proxy)/プロキシサーバ(proxy server)/HTTPプロキシ(HTTP proxy)
    - HTTP通信を中継し、代理でHTTPの通信を行なうサーバです。
    - 代理でHTTPへの通信を行なうので、HTTPクライアント(ユーザエージェント)としての機能も持っています。プロキシを複数組み合わせて多段にもできます。

プロキシの種類には、大きくわけて、フォワードプロキシと、リバースプロキシがあります。
関連資料を読むときに役に立つので、派生の用語も説明します。

- HTTPサーバ(HTTP server)
    - HTTPのサービスを提供するサーバです。HTTPプロトコルを使っていることを明言していることが「Webサーバ」と主な違いです。
    - 今、普及しているWebサーバはHTTPサーバなので、現実的にはWebサーバと同義です、将来HTTPを使ってないWebサーバが普及するかもしれませんが…。
- HTTPクライアント(HTTP client)/ユーザエージェント(user agent)
    - Webサーバにアクセスするプログラムの総称です。ブラウザのユーザエージェントの1つです。HTTPは閲覧以外にも利用できるので、ブラウザ以外のプログラムも含まれます。
    - 例えば、Webページの表示機能の無い、curlやwgetなどのHTTPを使うダウンロードツールなども、HTTPクライアント(ユーザエージェント)に含まれます。
- フォワードプロキシ(forward proxy)
    - HTTPクライアント(ユーザエージェント)の代理をするプロキシです。
    - HTTPプロトコルの使われ方が変わるので、プロキシが代理をする対象が、HTTPサーバなのか、HTTPクライアント(ユーザエージェント)なのかを区別したいときに使います。
- リバースプロキシ(reverse proxy)
    - HTTPサーバの代理をするプロキシです。
    - HTTPプロトコルの使われ方が変わるので、プロキシが代理をする対象が、HTTPサーバなのか、HTTPクライアント(ユーザエージェント)なのかを区別したいときに使います。




## 効率的なキャッシュの利用
- キャッシュ期間を長くすると
    - サーバとの通信量を削減できる！
    - 新しいデータに更新(refresh)されず，古いデータを表示してしまう...
- キャッシュ期間を短くすると
    - 新しいデータに対応できる！
    - データの更新がないのに，サーバへ無駄な通信が発生してしまう...


キャッシュ期間とデータ更新はトレードオフの関係にある
→「検証」を行うことで，更新を反映しつつ，キャッシュを長く再利用できる！

> [!NOTE]
> キャッシュ期間は短いが，無駄な更新をしないために，HTTPレスポンスの「304 Not Modified」を使って解決する！


---


- 304 Not Modifiedが帰ってきた場合
    - データは送られてこないため既存のキャッシュを再利用する
    - 利用したキャッシュのキャッシュ期間を延長する

## Webアプリ側の 304 処理設定
1. コンテンツ(ファイル)の更新時間の新しさで判断する(If-Modified-Sinceヘッダ利用)
2. コンテンツ(ファイル)の識別子の一致で判断する(If-None-Matchヘッダ利用)

> [!WARNING]
> Webサーバに以下の実装がなければフル無視されてキャッシュ利用できない


### コンテンツ更新時間による処理
- Webサーバ
    - コンテンツ更新時間をレスポンスの`Last-Modified`ヘッダにつけて応答
    - もしリクエストに`If-Modified-Since`ヘッダがある場合
        - コンテンツが新しい → コンテンツ
        - コンテンツが古い → 304
- ブラウザ
    - キャッシュしているデータの`Last-Modified`ヘッダを`If-Modified-Since`ヘッダにつけてリクエスト



### コンテンツ識別子による処理
- Webサーバ
    - コンテンツの識別子をレスポンスの`ETag`ヘッダにつけて応答
    - もしリクエストに`If-None-Match`ヘッダがある場合
        - コンテンツのETagと一致 → 304
        - コンテンツのETagと不一致 → コンテンツとETag
- ブラウザ
    - キャッシュしているデータの`ETag`ヘッダを`If-None-Match`ヘッダにつけてリクエスト



> [!NOTE]
> `If-Modified-Since`と`If-None-Match`が同時に指定されている場合は`If-None-Match`が優先される
> → Etagの値で柔軟に(広告とブログ間でキャッシュ期間を分ける)一致条件を制御できるため



## プロキシのキャッシュ
- ブラウザとプロキシはキャッシュの複製処理は大きく変わらない
- しかし，管理している人が違うため区別する必要がある
    - クレカは本人以外に漏洩させないようキャッシュを制御すべきだよね...


---
## Cache-Control
- サーバからキャッシュを制御できるヘッダ
- ブラウザの要求時と応答時の2つで異なる意味を表す


### 要求時のCache-Control
- すでに保存されているキャッシュを使うかどうか，クライアント側が指定できる！
- スーパーリロードなど，最新データの強制取得の動作などで使われる
- 要求時の主要なディレクティブ
    - no-cache: 途中経路の古いキャッシュを無視して，最新のデータを要求する指定(max-age=0)
    - max-age: 利用できるキャッシュの新しさを制限して，新しいデータを秒単位で要求する指定

### 応答時のCache-Control
- かなり複雑で数も多く，状況によってディレクティブの意味が変わる...
- キャッシュの再利用に関わる動作だけに注目して解説

- [流れ](https://eng-blog.iij.ad.jp/wp-content/uploads/2023/03/cache_control-954x1024.png)はこちら
**キャッシュの再利用が決定される時**
1. 既存キャッシュに対して，キャッシュ更新の検証は必要か
2. 検証が不要な場合，キャッシュは新鮮か
3. 接続失敗時，キャッシュを使用するか

#### 「検証は必要か？」
- ブラウザがキャッシュ期間を無視して，キャッシュの検証を行うか決める判断
- 検証が行われる場合
    - キャッシュが更新されて，最新データが表示される
    - つまりキャッシュを利用していないことと同等
**一般的な利用方法**
- no-cache
    - 対象: ブラウザとプロキシ
    - 検証する
    - リクエストはキャッシュを利用しないが，レスポンスが304ならキャッシュを利用する．200ならキャッシュを更新する
- no-store
    - 対象: ブラウザとプロキシ
    - 検証する
    - 304でもキャッシュの更新すらしてはいけない．
- public
    - 対象: プロキシ
    - 検証する
    - 複数のユーザ間でキャッシュを再利用することを許可する．全員が見ても問題ないコンテンツ
- private
    - 対象: プロキシ
    - 検証する
    - 複数のユーザ間でキャッシュを再利用しない．同じURLからユーザごとに異なるコンテンツ

### 「キャッシュは新鮮か？」
- キャッシュ期間を超えて古くなっていないかを，サーバ接続前に判断する処理(検証なしでキャッシュを活用するか判断する処理)
**一般的な利用方法**
- max-age
    - キャッシュ期間の適用対象: ブラウザとプロキシ
- s-maxage
    - キャッシュ期間の適用対象: プロキシ
- 両方指定
    - キャッシュ期間の適用対象: ブラウザ→max-age, プロキシ→s-maxage


### 「接続失敗時，キャッシュを利用するか？」
- 認証失敗もキャッシュ利用してしまうので，情報漏洩につながる危険性あり
- no-storeなどを利用して強制的にキャッシュさせないことも必要

---
- 意図的に通信エラーを起こしてキャッシュを狙う攻撃がある
- キャッシュはWebサーバやCDN, プロキシなど多段になることがあるため，影響範囲を考える必要がある

## 顧客情報を扱うページだが，更新頻度は低いからキャッシュしたい
- ブラウザのキャッシュは再利用して欲しい
- プロキシのキャッシュは再利用して欲しくない
    - private
- 反映の遅れが許されるためキャッシュ期間を長くできる (仮に300秒で、max-age=300)
- 認証失敗で表示されたくない。(no-store、must-revalidateのどちらかが必要)


- つまり`Cache-Control: max-age=300, private, must-revalidate`


## その他
- その他ユースケースは[本記事](https://eng-blog.iij.ad.jp/archives/18666)を参照

